<!-- @import { Button, Dialog, Field, Input, Label } from ../../lib/maddex -->
<!-- @import { DialogClose, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from ../../lib/maddex/Dialog.py -->
<!-- @import FieldGroup from ../../lib/maddex/Field.py -->
<div open="[[open]]" onOpenChange="[[onOpenChange]]">
  <Dialog open="{open}" onOpenChange="{onOpenChange}">
    <form onsubmit="saveProfile(event)">
      <DialogContent class="sm:max-w-sm">
        <DialogHeader>
          <DialogTitle>Edit profile</DialogTitle>
          <DialogDescription>
            Make changes to your profile here. Click save when you&apos;re done.
          </DialogDescription>
          <p class="text-destructive">{requestMessage}</p>
        </DialogHeader>
        <FieldGroup>
          <Field>
            <Label for="name-1">Name</Label>
            <Input
              id="name-1"
              name="name"
              placeholder="Pedro Duarte"
              value="{userName}"
              oninput="setUserName(event.target.value)"
            />
          </Field>
        </FieldGroup>
        <DialogFooter>
          <DialogClose asChild>
            <Button variant="outline">Cancel</Button>
          </DialogClose>
          <Button type="submit" disabled="{loading}">{loading ? "Saving..." : "Save changes"}</Button>
        </DialogFooter>
      </DialogContent>
    </form>
  </Dialog>

  <script>
    const userProfileJson = [[user | json]];
    const [userName, setUserName] = pp.state(userProfileJson.name || "");
    const [loading, setLoading] = pp.state(false);
    const [requestMessage, setRequestMessage] = pp.state("");

    async function saveProfile(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const name = formData.get("name");
      console.log("Saving profile with name:", name);

      setLoading(true);
      const response = await pp.rpc("save_profile", { name });
      console.log("Response from server:", response);

      if (!response.success) {
        setRequestMessage(response.message);
      } else {
        setRequestMessage("Profile updated successfully!");
      }

      setLoading(false);
      onOpenChange(false);
    }
  </script>
</div>
